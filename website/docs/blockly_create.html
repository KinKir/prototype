<html>
<head>
<style>
</style>
<script src="jquery.min.js" type="text/javascript"></script>
<script src="jquery-ui.min.js" type="text/javascript"></script>

<script type="text/javascript" src="js/acorn_interpreter.js"></script>

<script type="text/javascript" src="blockly/blockly_compressed.js"></script>
<script type="text/javascript" src="blockly/blocks_compressed.js"></script>
<script type="text/javascript" src="blockly/python_compressed.js"></script>
<script type="text/javascript" src="blockly/javascript_compressed.js"></script>
<script type="text/javascript" src="blockly/msg/js/en.js"></script>

        <script type="text/javascript" src="blockly/blocks/microbug.js"></script>
        <script type="text/javascript" src="blockly/generators/javascript/microbug.js"></script>
        <script type="text/javascript" src="blockly/generators/python/microbug.js"></script>
        <script type="text/javascript" src="js/simio.js"></script>
        <script type="text/javascript" src="dal_worker_esque.js"></script>

<script>
function buildCode() {
    var code = Blockly.Python.workspaceToCode();

    var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
    var xml_text = Blockly.Xml.domToText(xml);


    $("#codeblock").html("<P><PRE>" + code  + "</PRE>");
    $.ajax({
            type: "POST",
            url: "/cgi-bin/upload.py",
            data: JSON.stringify({"repr" : { "code": code, "xml" : xml_text }}),
            success: function( data ) {
                                      var someid = data["id"];
                                        text = '<P>Link to this version - <a href="/blockly_reload.html?id=' +  someid + '"> ' + someid.toString() +' </a>';
                                        $( "#resultblock" ).html( text );
                                      },
           });
}

</script>





</head>
<body>
<h1> MicroBug</h1>
<P> [ <a href="/blockly_create.html">Create</a> | <a href="/blockly_listprograms.html">all programs</a> | <a href="/cgi-bin/dump_uploads.py">debug dump</a>]
<hr>
<P>


<button type="button" onclick="flibbleCode()">flibbleCode</button>
<button type="button" onclick="buildCode()">Build Code</button>
    <button onclick="runCode()">Run JavaScript</button>
    <input type="text" id="pausetime" value="1000">
<!--    <button onclick="parseCode()">Parse JavaScript</button>
    <button onclick="stepCode()" id="stepButton" disabled="disabled">Step JavaScript</button> -->

<div id="codeblock" style="width: 90%; border: dotted;margin:1em; padding: 1em;">
<PRE>
# Codeblock
</PRE>
</div>

<div id="resultblock" style="width: 90%; border: dotted;margin:1em; padding: 1em;">
<P>Server result goes here
</div>

        <div id="SIMIO" style="width:128px;"></div>


<div id="blocklyDiv" style="width: 92%; margin:1em; height: 480px; "></div>

  <xml id="toolbox" style="display: none">
    <category name="Microbug">
            <category name="Eyes">
                    <block type="microbug_seteye"></block>
                    <block type="microbug_eyeon"></block>
                    <block type="microbug_eyeoff"></block>
            </category>
            <category name="Display">
                    <block type="microbug_scrollstring"></block>
                    <block type="microbug_printmessage"></block>
                    <block type="microbug_showletter"></block>
                    <block type="microbug_cleardisplay"></block>
                    <block type="microbug_plot"></block>
                    <block type="microbug_unplot"></block>
                    <block type="microbug_point"></block>
            </category>
            <category name="Buttons">
                    <block type="microbug_getbutton"></block>
            </category>
    </category>


    <category name="Control Structures">
        <block type="controls_if"></block>
        <block type="controls_if_elseif"></block>
        <block type="controls_repeat_ext"></block>
    </category>
    <category name="operations">
        <block type="logic_compare"></block>
        <block type="math_arithmetic"></block>
    </category>

    <category name="Values">
        <block type="math_number"></block>
        <block type="text"></block>
    </category>

    <category name="Functions">
        <block type="text_print"></block>
    </category>
    <category name="User functions">
        <block type="text_print"></block>
    </category>
  </xml>

  <xml id="startBlocks" style="display: none">

<block type="controls_repeat_ext" id="1" inline="true" x="81" y="90"><value name="TIMES"><block type="math_number" id="2"><field name="NUM">5</field></block></value><statement name="DO"><block type="microbug_scrollstring" id="15" inline="false"><value name="Message"><block type="text" id="18"><field name="TEXT">HELLO WORLD</field></block></value><value name="Speed"><block type="math_number" id="21"><field name="NUM">100</field></block></value><next><block type="microbug_printmessage" id="3" inline="false"><value name="message"><block type="text" id="4"><field name="TEXT">HELLO</field></block></value><value name="pausetime"><block type="math_number" id="5"><field name="NUM">100</field></block></value><next><block type="text_print" id="6" inline="false"><value name="TEXT"><block type="text" id="7"><field name="TEXT">WORLD</field></block></value></block></next></block></next></block></statement></block>

  </xml>

  <script type="text/javascript">
  Blockly.inject(document.getElementById('blocklyDiv'),
                   { path: './',
                     toolbox: document.getElementById('toolbox'),
                     trashcan: false
                   });

    // Sim Renderer
    SIMIO.init("SIMIO");
                       eyeOn("L");
                       eyeOn("R");
                       scrollString('READY', 100);
                       setDirtyCallback(SIMIO.render);

    Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,
        document.getElementById('startBlocks'));

    var myInterpreter = null;
    var myInterval = null;

    function initApi(interpreter, scope) {

      // Add an API function for the alert() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));


      // Add an API function for the prompt() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(scope, 'prompt',
          interpreter.createNativeFunction(wrapper));


      // Add an API function for the printMessage() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(printMessage(text));
      };
      interpreter.setProperty(scope, 'printMessage',
          interpreter.createNativeFunction(wrapper));


      // Add an API function for the scrollString() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(scrollString(text));
      };
      interpreter.setProperty(scope, 'scrollString',
          interpreter.createNativeFunction(wrapper));



      // Add an API function for highlighting blocks.
      var wrapper = function(id) {
        id = id ? id.toString() : '';
        return interpreter.createPrimitive(highlightBlock(id));
      };
      interpreter.setProperty(scope, 'highlightBlock',
          interpreter.createNativeFunction(wrapper));



    }

    var highlightPause = false;

    function highlightBlock(id) {
      Blockly.mainWorkspace.highlightBlock(id);
      highlightPause = true;
    }

    function runCode() {
        parseCode();
        stepCode();
    }
    function parseCode() {
      // Generate JavaScript code and parse it.
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      var code = Blockly.JavaScript.workspaceToCode();


      myInterpreter = new Interpreter(code, initApi);




      alert('Ready to execute this code:\n\n' + code);
      highlightPause = false;
      Blockly.mainWorkspace.traceOn(true);
      Blockly.mainWorkspace.highlightBlock(null);
    }

    
    function stepCode() {
      if (! device_ready()) {
          setTimeout(function () {
                stepCode();
                }, 50);
          return;
      }
      try {
        var ok = myInterpreter.step();
      } finally {
        if (!ok) {
          // Program complete, no more code to execute.
          return;
        }
      }
      if (highlightPause) {
        // A block has been highlighted.  Pause execution here.
            var pausebutton = document.getElementById('pausetime');
            var delay = parseInt(document.getElementById('pausetime').value);

            highlightPause = false;
            setTimeout(function () {
                stepCode();
                },delay );
      } else {
        // Keep executing until a highlight statement is reached.
        stepCode();
      }
    }

function flibbleCode() {
Blockly.mainWorkspace.highlightBlock('1');
for(var count = 0; count < 5;count++) {
   Blockly.mainWorkspace.highlightBlock('3');
   printMessage('HELLO',200);Blockly.mainWorkspace.highlightBlock('6');
   alert('WORLD');
   Blockly.mainWorkspace.highlightBlock('1');
};
}

</script>

<hr>
Contact: michael.sparks@bbc.co.uk

</body>
</html>
