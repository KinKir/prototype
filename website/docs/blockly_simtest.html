<!DOCTYPE html>
<html lang="en">
<head>
	<script src="jquery.min.js" type="text/javascript"></script>
	<script src="jquery-ui.min.js" type="text/javascript"></script>

	<script type="text/javascript" src="blockly/blockly_compressed.js"></script>
	<script type="text/javascript" src="blockly/blocks_compressed.js"></script>
	<script type="text/javascript" src="blockly/python_compressed.js"></script>
	<script type="text/javascript" src="blockly/javascript_compressed.js"></script>
	<script type="text/javascript" src="blockly/msg/js/en.js"></script>

	<script type="text/javascript" src="blockly/blocks/microbug.js"></script>
	<script type="text/javascript" src="blockly/generators/javascript/microbug.js"></script>

	<script type="text/javascript" src="js/simio.js"></script>
</head>

<body>
	<h1> MicroBug</h1>
	<P> [ <a href="/blockly_create.html">Create</a> | <a href="/blockly_listprograms.html">all programs</a> | <a href="/cgi-bin/dump_uploads.py">debug dump</a>]
	<hr>
	<P>
	<button type="button" id="BuildCodeButton">Build Code</button>
	<div id="codeblock" style="width: 90%; border: dotted;margin:1em; padding: 1em;">
		<PRE>
		# Codeblock
		</PRE>
	</div>
	<!-- div id="resultblock" style="width: 90%; border: dotted;margin:1em; padding: 1em;">
		<P>Server result goes here
	</div -->
	<div id="SIMIO" style="width:128px;"></div>

	<div id="blocklyDiv" style="width: 80%; margin:1em; height: 480px;"></div>

		<xml id="toolbox" style="display: none">
			<category name="Microbug">
				<category name="Eyes">
					<block type="microbug_seteye"></block>
					<block type="microbug_eyeon"></block>
					<block type="microbug_eyeoff"></block>
				</category>
				<category name="Display">
					<!-- block type="microbug_scrollstring"></block> -->
					<block type="microbug_printmessage"></block>
					<block type="microbug_showletter"></block>
					<block type="microbug_cleardisplay"></block>
					<block type="microbug_plot"></block>
					<block type="microbug_unplot"></block>
					<block type="microbug_point"></block>
				</category>
				<category name="Buttons">
					<block type="microbug_getbutton"></block>
				</category>
			</category>

			<category name="Variables">
				<block type="variables_get"></block>
				<block type="variables_set"></block>
			</category>
			<category name="Control Structures">
					<block type="controls_if"></block>
					<block type="controls_if_if"></block>
					<block type="controls_if_elseif"></block>
					<block type="controls_if_else"></block>
			</category>
			<category name="operations">
					<block type="logic_compare"></block>
					<block type="logic_operation"></block>
					<block type="logic_negate"></block>
					<block type="logic_boolean"></block>
					<block type="math_arithmetic"></block>
			</category>

			<category name="Loops">
				<block type="controls_whileUntil"></block>
				<block type="controls_for"></block>
			</category>

			<category name="Values">
					<block type="math_number"></block>
					<block type="text"></block>
			</category>
		</xml>
	</div>
	<hr>
	Contact: michael.sparks@bbc.co.uk

	<script type="text/javascript">
		Blockly.inject(document.getElementById('blocklyDiv'),
		{
			path: './',
			toolbox: document.getElementById('toolbox'),
			trashcan: false
		});

		$(document).ready(function() {
			// DAL (sim) worker
			var worker = new Worker('js/dal_worker.js');

			// Sim Renderer
			SIMIO.init("SIMIO");

			worker.addEventListener('message', function(e) {
				SIMIO.render(e.data.display, e.data.eyes);
			});

			// Code Build
			var buildCode = function() {
				//var code = Blockly.Python.workspaceToCode();
				var code = Blockly.JavaScript.workspaceToCode();
				worker.postMessage(code);

				var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
				var xml_text = Blockly.Xml.domToText(xml);

				$("#codeblock").html("<P><PRE>" + code  + "</PRE>");
				// $.ajax({
				// 	type: "POST",
				// 	url: "/cgi-bin/upload.py",
				// 	data: JSON.stringify({"repr" : { "code": code, "xml" : xml_text }}),
				// 	success: function( data ) {
				// 		var someid = data["id"];
				// 		text = '<P>Link to this version - <a href="/blockly_reload.html?id=' +  someid + '"> ' + someid.toString() +' </a>';
				// 		$( "	#resultblock" ).html( text );
				// 	},
				// });
			}
			document.getElementById("BuildCodeButton").addEventListener("click", buildCode);

		});
	</script>
</body>
</html>