<!DOCTYPE html>
<html lang="en">
<head>
	<script src="jquery.min.js" type="text/javascript"></script>
	<script src="jquery-ui.min.js" type="text/javascript"></script>

	<script type="text/javascript" src="blockly/blockly_compressed.js"></script>
	<script type="text/javascript" src="blockly/blocks_compressed.js"></script>
	<script type="text/javascript" src="blockly/python_compressed.js"></script>
	<script type="text/javascript" src="blockly/javascript_compressed.js"></script>
	<script type="text/javascript" src="blockly/msg/js/en.js"></script>

	<script type="text/javascript" src="js/dal_worker.js"></script>
	<!-- <script type="text/javascript" src="js/acorn_interpreter.js"></script> -->
	<script type="text/javascript" src="js/acorn.js"></script>
	<script type="text/javascript" src="js/interpreter.js"></script>

	<script type="text/javascript" src="blockly/blocks/microbug.js"></script>
	<script type="text/javascript" src="blockly/generators/javascript/microbug.js"></script>
	<script type="text/javascript" src="blockly/generators/python/microbug.js"></script>

	<script type="text/javascript" src="js/simio.js"></script>
</head>

<body>
	<h1> MicroBug</h1>
	<P> [ <a href="/blockly_create.html">Create</a> | <a href="/blockly_listprograms.html">all programs</a> | <a href="/cgi-bin/dump_uploads.py">debug dump</a>]
	<hr>
	<P>
	<button type="button" id="BuildCodeButton">Build Code</button>
	<button type="button" id="RunCodeButton">Run Simulator</button>
    <input type="text" id="pausetime" value="1000">

	<div id="codeblock" style="width: 90%; border: dotted;margin:1em; padding: 1em;">
		<PRE>
		# Codeblock
		</PRE>
	</div>
	<!-- div id="resultblock" style="width: 90%; border: dotted;margin:1em; padding: 1em;">
		<P>Server result goes here
	</div -->
	<div id="SIMIO" style="width:128px;"></div>

	<div id="blocklyDiv" style="width: 80%; margin:1em; height: 480px;"></div>

		<xml id="toolbox" style="display: none">
			<category name="Microbug">
				<category name="Eyes">
					<block type="microbug_seteye"></block>
					<block type="microbug_eyeon"></block>
					<block type="microbug_eyeoff"></block>
					<block type="microbug_toggleeye"></block>
				</category>
				<category name="Display">
					<block type="microbug_scrollstring"></block>
					<block type="microbug_printmessage"></block>
					<block type="microbug_showletter"></block>
					<block type="microbug_cleardisplay"></block>
					<block type="microbug_plot"></block>
					<block type="microbug_unplot"></block>
					<block type="microbug_point"></block>
					<block type="microbug_buildsprite"></block>
				<!--
					<block type="microbug_setdisplay"></block>
					<block type="microbug_showviewport"></block>
					<block type="microbug_scrollimage"></block>
					<block type="microbug_imagepoint"></block>
					<block type="microbug_setimagepoint"></block> -->
				</category>
				<category name="Buttons">
					<block type="microbug_getbutton"></block>
				</category>
			</category>

			<category name="Variables">
				<block type="variables_get"></block>
				<block type="variables_set"></block>
			</category>
			<category name="Control Structures">
					<block type="controls_if"></block>
					<block type="controls_if_if"></block>
					<block type="controls_if_elseif"></block>
					<block type="controls_if_else"></block>
			</category>
			<category name="operations">
					<block type="logic_compare"></block>
					<block type="logic_operation"></block>
					<block type="logic_negate"></block>
					<block type="logic_boolean"></block>
					<block type="math_arithmetic"></block>
			</category>

			<category name="Loops">
				<block type="controls_whileUntil"></block>
				<block type="controls_for"></block>
				<block type="controls_repeat_ext"></block>
			</category>

			<category name="Values">
					<block type="math_number"></block>
					<block type="text"></block>
			</category>
		</xml>
		
		<xml id="startBlocks" style="display: none">
<!--
<block type="microbug_seteye" id="13" inline="false" x="126" y="-40"><value name="id"><block type="text" id="16"><field name="TEXT">L</field></block></value><value name="state"><block type="math_number" id="19"><field name="NUM">1</field></block></value><next><block type="microbug_eyeon" id="1" inline="true"><value name="id"><block type="text" id="2"><field name="TEXT">R</field></block></value><next><block type="controls_repeat_ext" id="3" inline="true"><value name="TIMES"><block type="math_number" id="4"><field name="NUM">3</field></block></value><statement name="DO"><block type="microbug_printmessage" id="5" inline="false"><value name="message"><block type="text" id="6"><field name="TEXT">MONKEY</field></block></value><value name="pausetime"><block type="math_number" id="7"><field name="NUM">100</field></block></value></block></statement></block></next></block></next></block></xml> -->

<!--
<block type="microbug_setdisplay" id="33" inline="true" x="130" y="234"><value name="SPRITE"><block type="microbug_buildsprite" id="22"><field name="LED04">TRUE</field><field name="LED14">FALSE</field><field name="LED24">FALSE</field><field name="LED34">TRUE</field><field name="LED44">FALSE</field><field name="LED03">FALSE</field><field name="LED13">FALSE</field><field name="LED23">FALSE</field><field name="LED33">FALSE</field><field name="LED43">FALSE</field><field name="LED02">FALSE</field><field name="LED12">FALSE</field><field name="LED22">FALSE</field><field name="LED32">FALSE</field><field name="LED42">FALSE</field><field name="LED01">TRUE</field><field name="LED11">FALSE</field><field name="LED21">FALSE</field><field name="LED31">FALSE</field><field name="LED41">TRUE</field><field name="LED00">FALSE</field><field name="LED10">TRUE</field><field name="LED20">TRUE</field><field name="LED30">TRUE</field><field name="LED40">FALSE</field></block></value></block></xml> 
-->

<!--
<block type="variables_set" id="22" inline="true" x="147" y="47"><field name="VAR">item</field><value name="VALUE"><block type="microbug_imagepoint" id="14" inline="false"><value name="id"><block type="microbug_buildsprite" id="2"><field name="LED04">TRUE</field><field name="LED14">FALSE</field><field name="LED24">FALSE</field><field name="LED34">TRUE</field><field name="LED44">FALSE</field><field name="LED03">FALSE</field><field name="LED13">FALSE</field><field name="LED23">FALSE</field><field name="LED33">FALSE</field><field name="LED43">FALSE</field><field name="LED02">FALSE</field><field name="LED12">FALSE</field><field name="LED22">FALSE</field><field name="LED32">FALSE</field><field name="LED42">FALSE</field><field name="LED01">TRUE</field><field name="LED11">FALSE</field><field name="LED21">FALSE</field><field name="LED31">FALSE</field><field name="LED41">TRUE</field><field name="LED00">FALSE</field><field name="LED10">TRUE</field><field name="LED20">TRUE</field><field name="LED30">TRUE</field><field name="LED40">FALSE</field></block></value><value name="x"><block type="math_number" id="25"><field name="NUM">0</field></block></value><value name="y"><block type="math_number" id="28"><field name="NUM">1</field></block></value></block></value></block></xml>
-->

<!-- Testing some stuff THAT'S SUPPORTED, e.g. demoable  -->

<block type="microbug_seteye" id="1" inline="false" x="170" y="25"><value name="id"><block type="text" id="2"><field name="TEXT">L</field></block></value><value name="state"><block type="math_number" id="3"><field name="NUM">1</field></block></value><next><block type="microbug_seteye" id="4" inline="false"><value name="id"><block type="text" id="5"><field name="TEXT">R</field></block></value><value name="state"><block type="math_number" id="6"><field name="NUM">1</field></block></value><next><block type="microbug_showletter" id="7" inline="true"><value name="letter"><block type="text" id="8"><field name="TEXT">O</field></block></value><next><block type="microbug_showletter" id="9" inline="true"><value name="letter"><block type="text" id="10"><field name="TEXT">K</field></block></value><next><block type="microbug_cleardisplay" id="11"><next><block type="microbug_plot" id="12" inline="true"><value name="x"><block type="math_number" id="13"><field name="NUM">2</field></block></value><value name="y"><block type="math_number" id="14"><field name="NUM">2</field></block></value><next><block type="microbug_unplot" id="15" inline="true"><value name="x"><block type="math_number" id="16"><field name="NUM">2</field></block></value><value name="y"><block type="math_number" id="17"><field name="NUM">2</field></block></value><next><block type="microbug_printmessage" id="18" inline="false"><value name="message"><block type="text" id="19"><field name="TEXT">HELLO WORLD</field></block></value><value name="pausetime"><block type="math_number" id="20"><field name="NUM">50</field></block></value><next><block type="controls_repeat_ext" id="50" inline="true"><value name="TIMES"><block type="math_number" id="53"><field name="NUM">3</field></block></value><statement name="DO"><block type="microbug_scrollstring" id="35" inline="false"><value name="Message"><block type="text" id="36"><field name="TEXT">BANANAS</field></block></value><value name="Speed"><block type="math_number" id="37"><field name="NUM">50</field></block></value></block></statement></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></xml> 

	</div>
	<hr>
	Contact: michael.sparks@bbc.co.uk

	<script type="text/javascript">
		Blockly.inject(document.getElementById('blocklyDiv'),
		{
			path: './',
			toolbox: document.getElementById('toolbox'),
			trashcan: false
		});

		$(document).ready(function() {
			// Sim Renderer
			SIMIO.init("SIMIO");
			DALJS.setDirtyCallback(SIMIO.render);

			//Add start blocks if defined - idea: dump them out to console?
			Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, document.getElementById('startBlocks'));

		    var myInterpreter = null;
		    var myInterval = null;

			function initInterpreterApi(interpreter, scope)
			{
			    function makeWrapper(fn)
			    {
			    	return function()
			    	{
						for (var j = 0; j < arguments.length; j++) {
							arguments[j] = arguments[j].toString();
						}
			    		return interpreter.createPrimitive(fn.apply(this, arguments));
			    	}
			    }
			    function makeInterp(text, fn)
			    {
				    interpreter.setProperty(scope, text, 
				    	interpreter.createNativeFunction(
				    		makeWrapper(fn)));
			    }

			    makeInterp('prompt', prompt);
			    makeInterp('alert', alert);
			    makeInterp('highlightBlock', highlightBlock);

			    makeInterp('scrollString', DALJS.scrollString);
			    makeInterp('setEye', DALJS.setEye);
			    makeInterp('eyeOn', DALJS.eyeOn);
			    makeInterp('eyeOff', DALJS.eyeOff);
			    makeInterp('printMessage', DALJS.printMessage);
			    makeInterp('showLetter', DALJS.showLetter);

			    makeInterp('getButton', DALJS.getButton); ///MRBTODO
			    makeInterp('clearDisplay', DALJS.clearDisplay);
				makeInterp('plot', DALJS.plot);
				makeInterp('unplot', DALJS.unplot);
				makeInterp('point', DALJS.point);
				makeInterp('buildSprite', DALJS.buildSprite);//MRBTODO comes through as flat array to interpreter
				makeInterp('toggleEye', DALJS.toggleEye);

				// Not working - need different interpreter code for objects...
				// makeInterp('setDisplay', DALJS.setDisplay);
				// makeInterp('showViewport', DALJS.showViewport);
				// makeInterp('scrollImage', DALJS.scrollImage);
				// makeInterp('imagePoint', DALJS.imagePoint);
				// makeInterp('setImagePoint', DALJS.setImagePoint);
			}	    

			var highlightPause = false;

			function highlightBlock(id)
			{
			    Blockly.mainWorkspace.highlightBlock(id);
			    highlightPause = true;
			}

			function runCode()
			{
				DALJS.reset();
			    parseCode();
			    stepCode();
			}

			function parseCode()
			{
				console.log("parseCode");
			    // Generate JavaScript code and parse it.
			    Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
			    Blockly.JavaScript.addReservedWords('highlightBlock');
			    
			    var code = Blockly.JavaScript.workspaceToCode();
			    alert('Ready to execute this code:\n\n' + code);
			    myInterpreter = new Interpreter(code, initInterpreterApi);
			    highlightPause = false;
			    Blockly.mainWorkspace.traceOn(true);
			    Blockly.mainWorkspace.highlightBlock(null);
			}

			function stepCode()
			{
			    if (!DALJS.deviceReady())
			    {
			        setTimeout(function()
			        {
			            stepCode();
			        }, 50);
			        return;
			    }

			    try
			    {
			        var ok = myInterpreter.step();
			    }
			    finally
			    {
			        if (!ok)
			        {
			            // Program complete, no more code to execute.
			            return;
			        }
			    }

			    if (highlightPause)
			    {
			        // A block has been highlighted.  Pause execution here.
			        var pausebutton = document.getElementById('pausetime');
			        var delay = parseInt(document.getElementById('pausetime').value);

			        highlightPause = false;
			        setTimeout(function()
			        {
			            stepCode();
			        }, delay);
			    }
			    else
			    {
			        // Keep executing until a highlight statement is reached.
			        stepCode();
			    }
			}

			// Code Build
			var buildCode = function() {
				var pycode = Blockly.Python.workspaceToCode();

				var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
				var xml_text = Blockly.Xml.domToText(xml);
				console.log(xml_text);

				$("#codeblock").html("<P><PRE>" + pycode  + "</PRE>" + "<P><PRE>" + pycode + "</PRE>");
    			$.ajax({
					type: "POST",
					url: "/cgi-bin/upload_mb.py",
					data: JSON.stringify({"repr" : { "code": pycode, "xml" : xml_text }}),
					success: function( data ) {
						var someid = data["id"];
						text = '<P>Link to this version - <a href="/blockly_reload.html?id=' +  someid + '"> ' + someid.toString() +' </a>';
						$( "#resultblock" ).html( text );
						},
				});
			};

			document.getElementById("BuildCodeButton").addEventListener("click", buildCode);
			document.getElementById("RunCodeButton").addEventListener("click", runCode);

		});
	</script>
</body>
</html>